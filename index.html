<html>
    <head>
        <script src="https://cdn.jsdelivr.net/npm/onnxjs/dist/onnx.min.js"></script>
    </head>
    <body>
        <h3>Image Classification using ONNX.js</h3>
        
        Upload Image: <input type='file' id='fileinput'/>
        <br>
        <canvas id='canvas'></canvas>
        
        <br><hr>
        <input type='button' value='Test' onclick='test()' />

        <script>
            var width=256, height=256;
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');
            canvas.width = width;
            canvas.height = height;


            const sess = new onnx.InferenceSession();
            const sessionPromise = sess.loadModel('./model_100.onnx');


            async function test(){
                const input = new onnx.Tensor(
                    getCanvasData(),
                    'float32', 
                    [1,3,width,height] 
                );

                const outputMap = await sess.run([input]);
                const outputTensor = outputMap.values().next().value;
                alert(outputTensor.data);
            }
            

            
            function getCanvasData(){
                var data = ctx.getImageData(0, 0, width, height).data;
                var ret = new Float32Array(3*width*height);
                
                for(var idx=0; idx<ret.length; idx+=3){
                    ret[idx] = data[4*idx];
                    ret[idx+1] = data[4*idx + 1];
                    ret[idx+2] = data[4*idx + 2];
                }
                console.log(ret);
                return ret;
            }





            function RefreshCanvas(e){
                var reader = new FileReader();
                reader.onload = function(event){
                    var img = new Image();
                    img.onload = function(){
                        ctx.drawImage(img, 0, 0, width, height);
                    }
                    img.src = event.target.result;
                }
                reader.readAsDataURL(e.target.files[0]); 
            }
            var fileinput = document.getElementById('fileinput');
            fileinput.addEventListener('change', RefreshCanvas, false);
            
        </script>
    </body>
</html>
